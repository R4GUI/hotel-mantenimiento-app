<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-1">
            <i class="bi bi-gear"></i> Mantenimiento
          </h2>
          <p class="text-muted">
            <span *ngIf="isAdmin">Gesti√≥n de mantenimientos preventivos y correctivos</span>
            <span *ngIf="!isAdmin">Mis mantenimientos asignados</span>
          </p>
        </div>
        <!-- Solo Admin puede programar nuevos mantenimientos -->
        <button class="btn btn-primary" (click)="abrirModal()" *ngIf="isAdmin">
          <i class="bi bi-plus-circle"></i> Programar Mantenimiento
        </button>
      </div>
    </div>
  </div>

  <!-- Tabla de Mantenimientos -->
  <div class="card border-0 shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Equipo</th>
              <th>√Årea</th>
              <th>Tipo</th>
              <th>Fecha Programada</th>
              <th>Responsable</th>
              <th>Tipo Mant.</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let mant of mantenimientos">
              <td>
                <strong>{{ getEquipoNombre(mant.id_equipo) }}</strong>
              </td>
              <td>
                <span class="badge bg-secondary">
                  {{ getEquipoArea(mant.id_equipo) }}
                </span>
              </td>
              <td>
                <span class="badge bg-dark">
                  {{ getEquipoTipo(mant.id_equipo) }}
                </span>
              </td>
              <td>{{ mant.fecha_programada | date:'dd/MM/yyyy' }}</td>
              <td>
                <i class="bi bi-person-circle"></i>
                {{ mant.responsable }}
              </td>
              <td>
                <span class="badge" [ngClass]="getTipoClass(mant.tipo_mantenimiento)">
                  {{ mant.tipo_mantenimiento }}
                </span>
              </td>
              <td>
                <span class="badge" [ngClass]="getBadgeClass(mant.estado)">
                  {{ mant.estado }}
                </span>
              </td>
              <td>
  <div class="btn-group-vertical btn-group-sm" role="group">
    <!-- BOT√ìN ORDEN DE TRABAJO (Todos los mantenimientos) -->
    <button class="btn btn-outline-info btn-sm mb-1" (click)="generarOrdenTrabajo(mant)">
      <i class="bi bi-file-earmark-text"></i> Orden de Trabajo
    </button>

    <!-- ADMIN: Puede editar y eliminar solo si est√° Programado -->
    <ng-container *ngIf="isAdmin && mant.estado === 'Programado'">
      <button class="btn btn-outline-primary btn-sm mb-1" (click)="editarMantenimiento(mant)">
        <i class="bi bi-pencil"></i> Editar
      </button>
      <button class="btn btn-outline-danger btn-sm mb-1" (click)="eliminarMantenimiento(mant.id_mantenimiento!)">
        <i class="bi bi-trash"></i> Eliminar
      </button>
    </ng-container>

    <!-- BOT√ìN INICIAR: Admin y Empleado (si es su mantenimiento) -->
    <ng-container *ngIf="puedeIniciar(mant) && (isAdmin || esMiMantenimiento(mant))">
      <button class="btn btn-success btn-sm mb-1" (click)="iniciarMantenimiento(mant)">
        <i class="bi bi-play-fill"></i> Iniciar
      </button>
    </ng-container>

    <!-- BOTONES CUANDO EST√Å EN PROCESO: Admin y Empleado (si es su mantenimiento) -->
    <ng-container *ngIf="puedeFinalizarOAgregarRefacciones(mant) && (isAdmin || esMiMantenimiento(mant))">
      <button class="btn btn-info btn-sm mb-1" (click)="abrirModalObservaciones(mant)">
        <i class="bi bi-chat-left-text"></i> Observaciones
      </button>
      <button class="btn btn-warning btn-sm mb-1" (click)="abrirModalRefacciones(mant)">
        <i class="bi bi-tools"></i> Refacciones
      </button>
      <button class="btn btn-primary btn-sm mb-1" (click)="finalizarMantenimiento(mant)">
        <i class="bi bi-check-circle"></i> Finalizar
      </button>
    </ng-container>

    <!-- BOT√ìN VER REPORTE (Solo si est√° Completado) -->
    <ng-container *ngIf="mant.estado === 'Completado'">
      <button class="btn btn-success btn-sm mb-1" (click)="generarReporteMantenimiento(mant)">
        <i class="bi bi-file-earmark-pdf"></i> Ver Reporte
      </button>
      
      <!-- Badge si NO hay modo editor -->
      <span class="badge bg-success" *ngIf="!puedeEditarConModoEditor(mant)">
        <i class="bi bi-check-circle-fill"></i> Completado
      </span>
    </ng-container>

    <!-- Mensaje si est√° cancelado (SIN MODO EDITOR) -->
    <ng-container *ngIf="mant.estado === 'Cancelado' && !puedeEditarConModoEditor(mant)">
      <span class="badge bg-danger">
        <i class="bi bi-x-circle-fill"></i> Cancelado
      </span>
    </ng-container>

    <!-- BOTONES DE MODO EDITOR (Para Completados y Cancelados) -->
    <ng-container *ngIf="puedeEditarConModoEditor(mant)">
      <button class="btn btn-warning btn-sm mb-1" (click)="reabrirMantenimiento(mant)">
        <i class="bi bi-arrow-counterclockwise"></i> Reabrir
      </button>
      <button class="btn btn-danger btn-sm mb-1" (click)="eliminarMantenimiento(mant.id_mantenimiento!)">
        <i class="bi bi-trash3-fill"></i> Eliminar
      </button>
    </ng-container>
                </div>
              </td>
            </tr>
            <tr *ngIf="mantenimientos.length === 0">
              <td colspan="8" class="text-center text-muted py-4">
                <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                <p class="mb-0 mt-2">
                  <span *ngIf="isAdmin">No hay mantenimientos registrados</span>
                  <span *ngIf="!isAdmin">No tienes mantenimientos asignados</span>
                </p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Crear/Editar (Solo Admin) - SIN COSTO ESTIMADO -->
<div class="modal fade show" [class.d-block]="mostrarModal" 
     [style.background]="mostrarModal ? 'rgba(0,0,0,0.5)' : 'none'" 
     *ngIf="mostrarModal && isAdmin">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-gear"></i>
          {{ modoEdicion ? 'Editar' : 'Programar' }} Mantenimiento
        </h5>
        <button type="button" class="btn-close" (click)="cerrarModal()"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">
                <i class="bi bi-wrench"></i> Equipo <span class="text-danger">*</span>
              </label>
              <select class="form-select" [(ngModel)]="mantenimientoActual.id_equipo" name="equipo" required>
                <option [value]="0">Seleccionar equipo</option>
                <option *ngFor="let equipo of equipos" [value]="equipo.id_equipo">
                  {{ equipo.marca }} {{ equipo.modelo }} - {{ equipo.numero_serie }}
                </option>
              </select>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">
                <i class="bi bi-calendar3"></i> Fecha Programada <span class="text-danger">*</span>
              </label>
              <input type="date" class="form-control" 
                     [(ngModel)]="mantenimientoActual.fecha_programada" 
                     name="fecha" required>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">
                <i class="bi bi-tools"></i> Tipo de Mantenimiento
              </label>
              <select class="form-select" [(ngModel)]="mantenimientoActual.tipo_mantenimiento" name="tipo">
                <option value="Preventivo">Preventivo</option>
                <option value="Correctivo">Correctivo</option>
                <option value="Inspecci√≥n">Inspecci√≥n</option>
              </select>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">
                <i class="bi bi-person"></i> Responsable <span class="text-danger">*</span>
              </label>
              <select class="form-select" [(ngModel)]="mantenimientoActual.responsable" name="responsable" required>
                <option value="">Seleccionar responsable</option>
                <option *ngFor="let empleado of empleadosDisponibles" [value]="empleado">
                  {{ empleado }}
                </option>
              </select>
            </div>

            <!-- QUITAMOS EL CAMPO DE COSTO ESTIMADO Y DESCRIPCI√ìN/OBSERVACIONES -->
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModal()">
          <i class="bi bi-x-circle"></i> Cancelar
        </button>
        <button type="button" class="btn btn-primary" (click)="guardarMantenimiento()">
          <i class="bi bi-save"></i> Guardar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Cambiar Estado -->
<div class="modal fade show" [class.d-block]="mostrarModalCambiarEstado" 
     [style.background]="mostrarModalCambiarEstado ? 'rgba(0,0,0,0.5)' : 'none'" 
     *ngIf="mostrarModalCambiarEstado && mantenimientoParaCambiarEstado">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-flag"></i> Cambiar Estado del Mantenimiento
        </h5>
        <button type="button" class="btn-close" (click)="cerrarModalCambiarEstado()"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label fw-bold">Equipo:</label>
          <p>{{ getEquipoNombre(mantenimientoParaCambiarEstado.id_equipo) }}</p>
        </div>
        <div class="mb-3">
          <label class="form-label">
            <i class="bi bi-flag"></i> Nuevo Estado <span class="text-danger">*</span>
          </label>
          <select class="form-select" [(ngModel)]="nuevoEstado" name="estado">
            <option value="Programado">Programado</option>
            <option value="En Proceso">En Proceso</option>
            <option value="Completado">Completado</option>
            <option value="Cancelado">Cancelado</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModalCambiarEstado()">
          <i class="bi bi-x-circle"></i> Cancelar
        </button>
        <button type="button" class="btn btn-primary" (click)="guardarCambioEstado()">
          <i class="bi bi-save"></i> Guardar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Agregar Observaciones/Descripci√≥n -->
<div class="modal fade show" [class.d-block]="mostrarModalObservaciones" 
     [style.background]="mostrarModalObservaciones ? 'rgba(0,0,0,0.5)' : 'none'" 
     *ngIf="mostrarModalObservaciones && mantenimientoParaObservaciones">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-chat-left-text"></i> Agregar Descripci√≥n y Observaciones
        </h5>
        <button type="button" class="btn-close" (click)="cerrarModalObservaciones()"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info mb-3">
          <strong>Equipo:</strong> {{ getEquipoNombre(mantenimientoParaObservaciones.id_equipo) }}<br>
          <strong>Responsable:</strong> {{ mantenimientoParaObservaciones.responsable }}
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">
            <i class="bi bi-file-text"></i> Descripci√≥n del Trabajo Realizado
          </label>
          <textarea class="form-control" 
                    [(ngModel)]="descripcionTemp" 
                    name="descripcion" 
                    rows="4"
                    placeholder="Describe detalladamente el trabajo realizado..."></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold">
            <i class="bi bi-chat-left-text"></i> Observaciones / Comentarios
          </label>
          <textarea class="form-control" 
                    [(ngModel)]="observacionesTemp" 
                    name="observaciones" 
                    rows="3"
                    placeholder="Agrega observaciones adicionales, problemas encontrados, recomendaciones..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModalObservaciones()">
          <i class="bi bi-x-circle"></i> Cancelar
        </button>
        <button type="button" class="btn btn-primary" (click)="guardarObservaciones()">
          <i class="bi bi-save"></i> Guardar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Refacciones -->
<div class="modal fade show" [class.d-block]="mostrarModalRefacciones" 
     [style.background]="mostrarModalRefacciones ? 'rgba(0,0,0,0.5)' : 'none'" 
     *ngIf="mostrarModalRefacciones && mantenimientoParaRefacciones">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-tools"></i> Refacciones del Mantenimiento
        </h5>
        <button type="button" class="btn-close" (click)="cerrarModalRefacciones()"></button>
      </div>
      <div class="modal-body">
        <!-- Informaci√≥n del mantenimiento -->
        <div class="alert alert-info mb-3">
          <strong>Equipo:</strong> {{ getEquipoNombre(mantenimientoParaRefacciones.id_equipo) }}<br>
          <strong>Responsable:</strong> {{ mantenimientoParaRefacciones.responsable }}<br>
          <strong>Tipo:</strong> {{ mantenimientoParaRefacciones.tipo_mantenimiento }}
        </div>

<!-- Formulario para agregar refacci√≥n -->
<div class="card mb-3">
  <div class="card-header bg-primary text-white">
    <h6 class="mb-0">
      <i class="bi bi-plus-circle"></i> Agregar Nueva Refacci√≥n
    </h6>
  </div>
  <div class="card-body">
    <form>
      <div class="row">
        <div class="col-md-6 mb-3">
          <label class="form-label">Nombre de la Refacci√≥n <span class="text-danger">*</span></label>
          <input type="text" class="form-control" 
                 [(ngModel)]="nuevaRefaccion.nombre_refaccion" 
                 name="nombre"
                 placeholder="Ej: Filtro de aire">
        </div>

        <div class="col-md-3 mb-3">
          <label class="form-label">Cantidad <span class="text-danger">*</span></label>
          <input type="number" class="form-control" 
                 [(ngModel)]="nuevaRefaccion.cantidad" 
                 name="cantidad"
                 min="1">
        </div>

        <div class="col-md-3 mb-3">
          <label class="form-label">Costo Unitario ($)</label>
          <input type="number" class="form-control" 
                 [(ngModel)]="nuevaRefaccion.costo_unitario" 
                 name="costo"
                 min="0"
                 step="0.01"
                 placeholder="0.00">
        </div>

        <!-- üëá SELECTOR DE PROVEEDOR MEJORADO -->
        <div class="col-md-9 mb-3">
          <label class="form-label">
            <i class="bi bi-shop"></i> Proveedor
          </label>
          <select class="form-select" 
                  [(ngModel)]="proveedorSeleccionado" 
                  name="proveedorSelect"
                  (change)="onProveedorChange()">
            <option value="">Seleccionar proveedor existente</option>
            <option *ngFor="let prov of proveedoresDisponibles" [value]="prov">
              {{ prov }}
            </option>
            <option value="nuevo">‚ûï Agregar nuevo proveedor</option>
          </select>
          
          <!-- Input para nuevo proveedor -->
          <input type="text" 
                 class="form-control mt-2" 
                 *ngIf="mostrarInputProveedor"
                 [(ngModel)]="nuevaRefaccion.proveedor" 
                 name="proveedorNuevo"
                 placeholder="Nombre del nuevo proveedor">
        </div>

        <div class="col-md-3 mb-3 d-flex align-items-end">
          <button type="button" class="btn btn-success w-100" (click)="agregarRefaccion()">
            <i class="bi bi-plus-lg"></i> Agregar
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

        <!-- Lista de refacciones -->
        <div class="card">
          <div class="card-header bg-light">
            <h6 class="mb-0">
              <i class="bi bi-list-ul"></i> Refacciones Agregadas
            </h6>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead>
                  <tr>
                    <th>Refacci√≥n</th>
                    <th>Cantidad</th>
                    <th>Costo Unit.</th>
                    <th>Subtotal</th>
                    <th>Proveedor</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let ref of refacciones">
                    <td>{{ ref.nombre_refaccion }}</td>
                    <td>{{ ref.cantidad }}</td>
                    <td>${{ ref.costo_unitario | number:'1.2-2' }}</td>
                    <td><strong>${{ (ref.costo_unitario! * ref.cantidad) | number:'1.2-2' }}</strong></td>
                    <td>{{ ref.proveedor || '-' }}</td>
                  </tr>
                  <tr *ngIf="refacciones.length === 0">
                    <td colspan="5" class="text-center text-muted py-3">
                      <i class="bi bi-inbox" style="font-size: 1.5rem;"></i>
                      <p class="mb-0 mt-2">No hay refacciones agregadas</p>
                    </td>
                  </tr>
                </tbody>
                <tfoot *ngIf="refacciones.length > 0">
                  <tr class="table-light">
                    <td colspan="3" class="text-end"><strong>TOTAL:</strong></td>
                    <td colspan="2"><strong>${{ getTotalRefacciones() | number:'1.2-2' }}</strong></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cerrarModalRefacciones()">
          <i class="bi bi-x-circle"></i> Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

